<!DOCTYPE html>
<html>

<head>
  <title>grid viewer</title>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <link rel="stylesheet" href="viewer-grid.css" />

</head>

<body>

  <div class="tools">
    <button id="mode">single selection</button>
    <button id="clear">clear selection</button>
  </div>

  <div id="grid" class="grid">
  </div>

  <script type="text/javascript">
    var grid = document.getElementById("grid")
    var metadata, metadataIds
    var expansionElement, metadataElement
    var last_row = -1;
    var last_col = -1;
    var points, imagexy = {};
    var startX, startY, dragSelection = [], selectedCells = [], selectedHash = {}, selectionMode = "expand", isSelecting = false;
    var expanded
    var btnMode = document.getElementById("mode")
    var btnClear = document.getElementById("clear")

    btnClear.onclick = clearSelection
    btnMode.onclick = (e) => {
      if (selectionMode === "expand") {
        selectionMode = "multiple"
        mode.innerHTML = "multiple selection"
      } else {
        selectionMode = "expand"
        mode.innerHTML = "single selection"
      }
    }

    window.onresize = function (e) {
      setRow()
    }

    var xmlhttp = new XMLHttpRequest(),
      method = 'GET',
      url = './metadata.min.json';
    xmlhttp.open(method, url, true);
    xmlhttp.onload = function (data) {
      metadata = {}
      var temp = JSON.parse(data.target.response)
      temp.forEach(t => metadata = Object.assign(metadata, t))
      init();
    };
    xmlhttp.send()

    function setRow() {
      if (!expanded) return;
      var topExpanded = expanded.offsetTop;
      if (topExpanded === 0) {
        // first row
        expansionElement.style = "grid-row-start: 2;"
        return;
      }
      // not in top so we need to find what row
      var tops = [topExpanded]
      var el = expanded.previousElementSibling
      while (el) {
        tops.push(el.offsetTop)
        el = el.previousElementSibling
      }
      var unique = tops.filter((val, idx, array) => array.indexOf(val) === idx);
      expansionElement.style = "grid-row-start: " + (unique.length + 1) + ";"
    }

    function createExpansion(sibling, url, colorurl, id, point) {
      var currentExpansion = document.getElementById("expansion")
      if (currentExpansion) currentExpansion.remove()
      var currentExpanded = expanded
      if (currentExpanded) {
        currentExpanded.classList.remove("expanded")
      }
      if (sibling === currentExpanded) {
        expanded = undefined;
        return
      }
      sibling.classList.add("expanded")
      expansionElement = document.createElement("div");
      expansionElement.setAttribute("id", "expansion")
      expansionElement.classList.add("expansion", "collapsed")
      if (sibling.classList.contains("selected")) expansionElement.classList.add("selected")
      var main = document.createElement("div");
      main.classList.add("main")
      var img = new Image();
      img.src = url;
      var imgDiv = document.createElement("div")
      imgDiv.classList.add("image-palette")
      var palette = document.createElement("ul");
      palette.classList.add("palette")
      palette.appendChild(document.createElement("li"))
      palette.appendChild(document.createElement("li"))
      palette.appendChild(document.createElement("li"))
      palette.appendChild(document.createElement("li"))
      palette.appendChild(document.createElement("li"))
      imgDiv.appendChild(palette);
      imgDiv.appendChild(img);
      main.appendChild(imgDiv);
      metadataElement = document.createElement("div");
      metadataElement.classList.add("metadata")
      main.appendChild(metadataElement)
      expansionElement.appendChild(main)
      var add = document.createElement("div");
      add.innerHTML = "add item"
      add.classList.add("add")
      add.setAttribute("data-id", id)
      add.setAttribute("data-point", point)
      add.onclick = (e) => {
        var p = e.target.getAttribute("data-point")
        var i = e.target.getAttribute("data-id")
        // console.log(p, i, e)
        addCell(p, i)
      }
      expansionElement.appendChild(add)
      sibling.insertAdjacentElement("afterend", expansionElement);
      loadColors(colorurl)
      getMetadata(id)
      expanded = sibling
      setTimeout(() => expansionElement.classList.remove("collapsed"), 10)
    }
    function gridItemClick(e) {
      var point = this.getAttribute("data-point")
      var id = this.getAttribute("data-id");
      var selected = selectedHash[point] === id;
      // console.log(point, id, selected)
      if (selected && selectionMode === "multiple") {
        removeCell(point)
        return
      }
      if (selectionMode === "multiple") {
        addCell(point, id)
        return
      }
      // console.log(point)
      var url = this.getAttribute("data-url");
      var colorurl = "/output-colors" + url.replace("/images/scaled", "").replace(".jpg", ".json")
      createExpansion(this, url, colorurl, id, point)
      setRow()
    }
    function init() {
      var xmlhttp = new XMLHttpRequest(),
        method = 'GET',
        url = './colors-v4-tSNE-gridwide-points.json';
      xmlhttp.open(method, url, true);
      xmlhttp.onload = function (data) {
        points = JSON.parse(data.target.response)
        points.sort((a, b) => a.point[1] < b.point[1] ? -1 : (a.point[1] > b.point[1] ? 1 : (a.point[0] < b.point[0] ? -1 : (a.point[0] > b.point[0] ? 1 : 0))))
        points.forEach(p => createThumbnail(p))
      };
      xmlhttp.send()
    }
    function createThumbnail(p) {
      var item = document.createElement("div")
      var url = p.path.replace("/Users/mga/Documents/website/cv", "");
      var id = url.replace("/images/scaled/", "").replace(".jpg", "")
      var meta = metadata[id]
      item.classList.add("item")
      item.setAttribute("data-url", url)
      item.setAttribute("data-id", id)
      item.setAttribute("id", id)
      item.setAttribute("data-point", p.point.toString())
      var itemImg = new Image();
      itemImg.src = url
      item.appendChild(itemImg)
      var itemMeta = document.createElement("div")
      itemMeta.classList.add("item-metadata")
      var checkbox = document.createElement("input")
      checkbox.setAttribute("type", "checkbox")
      checkbox.classList.add("checkbox")
      itemMeta.appendChild(checkbox)
      var title = document.createElement("h2")
      title.innerText = meta["sourceResource.title"]
      itemMeta.appendChild(title)
      var provider = document.createElement("p")
      provider.innerText = meta["provider.name"]
      itemMeta.appendChild(provider)
      item.appendChild(itemMeta)
      grid.appendChild(item)
      item.onclick = gridItemClick;
      // imagexy[p.point[0] + "," + p.point[1]] = p.path
    }
    function addCell(cell, id) {
      if (selectedHash[cell]) return;
      selectedHash[cell] = id;
      selectedCells.push(cell)
      selectedCells.sort()
      drawSelection()
    }
    function removeCell(cell) {
      var id = selectedHash[cell]
      delete selectedHash[cell];
      selectedCells.forEach((c, index) => {
        if (c === cell) {
          selectedCells.splice(index, 1);
          return;
        }
      })
      if (id) clearCell(id)
    }
    function clearSelection() {
      Object.values(selectedHash).forEach(id => {
        clearCell(id)
      })
      selectedHash = {}
      selectedCells = []
    }
    function clearCell(id) {
      document.getElementById(id).classList.remove("selected")
    }
    function drawSelection() {
      Object.values(selectedHash).forEach(id => {
        var item = document.getElementById(id).classList.add("selected")
      })
    }
    function getMetadata(id) {
      var item = metadata[id]
      metadataElement.innerHTML = "";
      var title = document.createElement("h3")
      title.classList.add("title")
      title.innerHTML = item["sourceResource.title"];
      metadataElement.appendChild(title)
      // if (item["sourceResource.description"]) {
      //   var description = document.createElement("p")
      //   description.innerHTML = item["sourceResource.description"];
      //   metadataElement.appendChild(description)
      // }
      var provider = document.createElement("a")
      provider.classList.add("provider")
      provider.innerHTML = item["provider.name"]
      provider.setAttribute("href", item.isShownAt)
      provider.setAttribute("target", "_blank")
      metadataElement.appendChild(provider)
      if (item["sourceResource.subject.name"]) {
        var subjects = document.createElement("ul")
        subjects.classList.add("subjects")
        item["sourceResource.subject.name"].forEach(s => {
          var subject = document.createElement("li")
          subject.innerHTML = s
          subjects.appendChild(subject)
        })
        metadataElement.appendChild(subjects)
      }
      // var meta = metadata[id]
      // var xmlhttp = new XMLHttpRequest(),
      //   method = 'GET',
      //   url = "https://dp.la/api/dpla/items?fields=sourceResource.description,sourceResource.date,sourceResource.title,sourceResource.subject.name,provider.name&id=" + id;

      // xmlhttp.open(method, url, true);
      // xmlhttp.onload = function (data) {
      //   var item = JSON.parse(data.target.response).docs[0]
      //   // console.log(item)
      // };
      // xmlhttp.send()
    }
    function loadColors(file) {
      var xmlhttp = new XMLHttpRequest(),
        method = 'GET',
        url = file;

      xmlhttp.open(method, url, true);
      xmlhttp.onload = function (data) {
        JSON.parse(data.target.response).imgdata[1].clusters.cluster.forEach((c, index) => {
          expansionElement.getElementsByTagName("li")[index].setAttribute("style", "width: " + (c[0].f * 100) + "%; background-color: " + c[2].hex[0].hex + ";")
        })
      };
      xmlhttp.send()
    }
  </script>

</body>

</html>